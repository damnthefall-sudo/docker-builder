name: Dispatcher Build

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Docker Login
      uses: docker/login-action@v1.9.0
      with:
          username: rzlamrr
          password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Build & Push
      run: bash build.sh

  scan:
    runs-on: ubuntu-latest
    needs:
      - build
    steps:
    - uses: actions/checkout@v2
    - uses: docker/login-action@v1.9.0
      with:
        username: rzlamrr
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Scan Image
      run: |
        bash build.sh test focal
        bash build.sh test lite
        bash build.sh test arch
    - name: Stage & Commit
      run: |
        git config --local user.email "rzlamrr.dvst@protonmail.com"
        git config --local user.name "rzlamrr"
        git add scan/
        git commit -m "ci: scan result"
    - uses: ad-m/github-push-action@v0.6.0
      with:
        directory: "scan/"
        branch: ${{ github.ref }}
        github_token: ${{ secrets.GITHUB_TOKEN }}